{% extends "base.html" %}

{% block title %}{{ source_label }} · {{ keyword_heading or '新闻搜索' }}{% endblock %}

{% block head %}{% endblock %}

{% block content %}
<section class="hero-card">
    <h1 class="section-title">{{ source_label }} · {{ keyword_heading or '新闻搜索' }}</h1>
    <form class="search-form" method="get" action="/search">
        <input type="text" class="search-input" name="keyword" value="{{ search_value or '' }}" placeholder="输入想追踪的关键词">
        <select name="source" class="search-select">
            {% for opt in available_sources %}
                <option value="{{ opt.key }}" {% if opt.key == source %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-primary search-button" type="submit">立即搜索</button>
    </form>
    <p class="meta-line">{{ result_summary or ('共 ' ~ total_results ~ ' 条结果') }} · 数据源：{{ source_label }}</p>
</section>

<section>
    <h2 class="section-heading">热门关键词</h2>
    <div class="keyword-cloud">
        {% if top_keywords_counts %}
            {% for item in top_keywords_counts %}
                {% set kw = item['keyword'] %}
                {% set count = item['count'] %}
                {% set denom = (max_count - min_count) if (max_count - min_count) != 0 else 1 %}
                {% set frac = (count - min_count) / denom %}
                {% set hue = 200 - (80 * frac) %}
                <a class="keyword-chip" href="/search?keyword={{ kw }}&source={{ source }}" style="background-color: hsl({{ hue }}, 70%, 92%); border-color: hsl({{ hue }}, 70%, 75%);">
                    {{ kw }} · {{ count }}
                </a>
            {% endfor %}
        {% else %}
            <span class="keyword-chip" style="background: #edf2f7; color: #718096;">暂无关键词</span>
        {% endif %}
    </div>
</section>

<div class="page-layout">
    <div>
        {% if results %}
            {% for news in results %}
                <article class="news-card">
                    <div class="news-card__meta">
                        <span class="badge badge-source">{{ news.source_badge }}</span>
                        <span class="badge badge-muted">{{ news.source }}</span>
                        <span>{{ news.date }}</span>
                        {% if news.similarity_score %}
                            <span class="badge badge-muted" style="border-color: transparent; color: var(--accent-color); font-weight: 600;">相关度 {{ '{:.2f}'.format(news.similarity_score) }}</span>
                        {% endif %}
                    </div>
                    <h3>{{ news.title }}</h3>
                    {% if news.url %}
                        <p><a href="{{ news.url }}" target="_blank">查看原文链接 ↗</a></p>
                    {% endif %}
                    <p><strong>摘要：</strong>{{ news.summary or '暂无摘要' }}</p>
                    <details>
                        <summary>展开原文</summary>
                        <p style="white-space: pre-wrap;">{{ news.original_text }}</p>
                    </details>
                    {% if news.keyword_list %}
                        <div class="news-card__footer">
                            <div class="keyword-tags">
                                {% for kw in news.keyword_list %}
                                    <span class="keyword-tag">{{ kw }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </article>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>没有找到相关新闻，可以尝试更换关键词或切换数据源。</p>
            </div>
        {% endif %}
    </div>
    <aside>
        <div class="trend-card">
            <h3 style="margin-bottom: 12px;">关键词日趋势</h3>
            <canvas id="trendChart" height="220"></canvas>
        </div>
    </aside>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = JSON.parse('{{ trend_labels | safe }}');
    const counts = JSON.parse('{{ trend_counts | safe }}');
    if (labels.length && counts.length) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: '每日热度',
                    data: counts,
                    borderColor: '#2b6cb0',
                    backgroundColor: 'rgba(43, 108, 176, 0.15)',
                    tension: 0.35,
                    pointRadius: 2,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { autoSkip: true, maxRotation: 0 } },
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>
{% endblock %}
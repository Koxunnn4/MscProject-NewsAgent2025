{% extends "base.html" %}

{% block title %}{{ source_label }} Â· {{ keyword_heading or 'æ–°é—»æœç´¢' }}{% endblock %}

{% block content %}
<div class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
<section class="search-hero">
    <h1>{{ source_label }} Â· {{ keyword_heading or 'æ–°é—»æœç´¢' }}</h1>
    <form class="search-form" method="get" action="/search">
        <input type="text" class="form-control" name="keyword" value="{{ search_value or '' }}" placeholder="è¾“å…¥æƒ³è¿½è¸ªçš„å…³é”®è¯">
        <select name="source" class="form-select">
            {% for opt in available_sources %}
                <option value="{{ opt.key }}" {% if opt.key == source %}selected{% endif %}>{{ opt.label }}</option>
            {% endfor %}
        </select>
        <button class="btn btn-primary" type="submit">ç«‹å³æœç´¢</button>
    </form>
    <div class="search-meta">
        <span>{{ result_summary or ('å…± ' ~ total_results ~ ' æ¡ç»“æœ') }}</span>
        <span>Â·</span>
        <span>æ•°æ®æºï¼š{{ source_label }}</span>
    </div>
</section>

<section class="keyword-section">
    <h2 class="section-title">çƒ­é—¨å…³é”®è¯</h2>
    <div class="keyword-cloud">
        {% if top_keywords_counts %}
            {% for item in top_keywords_counts %}
                {% set kw = item['keyword'] %}
                {% set count = item['count'] %}
                {% set denom = (max_count - min_count) if (max_count - min_count) != 0 else 1 %}
                {% set frac = (count - min_count) / denom %}
                {% set hue = 200 - (80 * frac) %}
                <a class="keyword-chip" href="/search?keyword={{ kw }}&source={{ source }}" style="background-color: hsl({{ hue }}, 70%, 92%); border-color: hsl({{ hue }}, 70%, 75%); color: #1a202c;">
                    {{ kw }} Â· {{ count }}
                </a>
            {% endfor %}
        {% else %}
            <span class="keyword-chip" style="background: #edf2f7; color: #718096;">æš‚æ— å…³é”®è¯</span>
        {% endif %}
    </div>
</section>

<div class="page-layout">
    <div>
        {% if results %}
            {% for news in results %}
                <article class="news-card">
                    <div class="news-meta">
                        <span class="badge badge-primary">{{ news.source_badge }}</span>
                        <span class="badge badge-outline">{{ news.source }}</span>
                        <span>{{ news.date }}</span>
                        {% if news.similarity_score %}
                            <span style="color: var(--primary-color); font-weight:600;">ç›¸å…³åº¦ {{ '{:.2f}'.format(news.similarity_score) }}</span>
                        {% endif %}
                    </div>
                    <h3 class="news-title">{{ news.title }}</h3>
                    {% if news.url %}
                        <p style="margin-bottom: 0.5rem;"><a href="{{ news.url }}" target="_blank" class="read-more">æŸ¥çœ‹åŸæ–‡é“¾æ¥ â†—</a></p>
                    {% endif %}
                    <div class="news-summary">
                        <strong>æ‘˜è¦ï¼š</strong>{{ news.summary or 'æš‚æ— æ‘˜è¦' }}
                    </div>
                    <details>
                        <summary>å±•å¼€åŸæ–‡</summary>
                        <p>{{ news.original_text }}</p>
                    </details>
                    {% if news.keyword_list %}
                        <div class="news-footer">
                            <div class="tag-list">
                                {% for kw in news.keyword_list %}
                                    <span class="tag">{{ kw }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </article>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <span class="empty-icon">ğŸ”</span>
                <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–°é—»ï¼Œå¯ä»¥å°è¯•æ›´æ¢å…³é”®è¯æˆ–åˆ‡æ¢æ•°æ®æºã€‚</p>
            </div>
        {% endif %}
    </div>
    <aside>
        <div class="news-card">
            <h3 class="section-title">å…³é”®è¯æ—¥è¶‹åŠ¿</h3>
            <canvas id="trendChart" height="220"></canvas>
        </div>
    </aside>
</div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const labels = JSON.parse('{{ trend_labels | safe }}');
    const counts = JSON.parse('{{ trend_counts | safe }}');
    if (labels.length && counts.length) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'æ¯æ—¥çƒ­åº¦',
                    data: counts,
                    borderColor: '#2563EB',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.35,
                    pointRadius: 3,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { autoSkip: true, maxRotation: 0 } },
                    y: { beginAtZero: true }
                }
            }
        });
    }
</script>
{% endblock %}